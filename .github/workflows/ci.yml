name: CI Pipeline

on:
  push:
    branches:
      - chat_server

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Check out code
      uses: actions/checkout@v2

    - name: Extract commit hash
      id: vars
      run: echo "COMMIT_HASH=$(git rev-parse --short HEAD)" >> $GITHUB_ENV

    - name: DockerHub 로그인
      uses: docker/login-action@v2
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}

    - name: Docker 이미지 빌드 및 푸시
      run: |
        echo "Using commit hash: ${{ env.COMMIT_HASH }}"
        docker build -t ${{ secrets.DOCKER_USERNAME }}/dododocs-ai:${{ env.COMMIT_HASH }} .
        docker push ${{ secrets.DOCKER_USERNAME }}/dododocs-ai:${{ env.COMMIT_HASH }}

    - name: Create .env file from GitHub Secrets
      run: |
        echo "${{ secrets.ENV_FILE }}" > .env

    - name: Copy .env to EC2
      uses: appleboy/scp-action@master
      with:
        host: 43.200.171.249
        username: ec2-user
        key: ${{ secrets.EC2_PRIVATE_KEY }}
        source: ./.env
        target: /home/ec2-user/

    - name: EC2 배포
      uses: appleboy/ssh-action@master
      with:
        host: 43.200.171.249
        username: ec2-user
        key: ${{ secrets.EC2_PRIVATE_KEY }}
        script: |
          docker stop dododocs-ai || true
          docker rm dododocs-ai || true
          docker run -d --name dododocs-ai --env-file /home/ec2-user/.env -p 80:5001 -v /home/ec2-user/ai-gen:/mnt/chroma_DB ${{ secrets.DOCKER_USERNAME }}/dododocs-ai:${{ env.COMMIT_HASH }}